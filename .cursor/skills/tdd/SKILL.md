---
name: tdd
description: t_wada式TDD（テスト駆動開発）プロセスのガイドライン
---

# Overview

このリポジトリで実装・改修・バグ修正を行うときの **t_wada式TDD**（テスト駆動開発）の進め方ガイドです。目的は「設計を小さく前進させながら、変更の安全性を高く保つ」ことです。

## 基本原則（忘れたらここに戻る）
- **テストが仕様を語る**: 「何ができるべきか」をまずテストで表現する
- **最小のステップ**: 1回の変更で増やす不確実性を最小にする
- **設計はリファクタで育てる**: 先に“きれいに作る”のではなく、動かしてから整える
- **外部は境界で隔離**: ブラウザ拡張APIやDOMなどの外部要因は薄い境界に閉じ込め、中心はテストしやすい形（純関数/小さなモジュール）に寄せる

## 進め方（Red → Green → Refactor）
### Red（失敗するテストを書く）
- **まず失敗させる**: 追加するテストは最初に必ず失敗させる（テストが効いている証拠）
- **失敗理由が一目で分かる**: 期待値・入力・名前を読みやすくする（失敗メッセージが仕様の説明になる）
- **粒度は“小さく”**: 1テスト = 1つのふるまい（分岐1つ、境界値1つ、例外1つ）

### Green（最短で通す）
- **最短で通す**: “美しい実装”は後回し。まずテストを通して学びを固定する
- **一気に作り込まない**: 予測での過剰実装を避け、必要になった分だけ一般化する
- **仮実装も許可**: 定数で返す/ベタ書きする等の「雑でも通る」実装はOK（ただし次のリファクタで返済する）

### Refactor（設計の負債を返す）
- **振る舞い不変**: テストが通ったまま構造だけを改善する
- **重複の除去が最優先**: 条件分岐の重複、テストデータ生成の重複、命名の揺れを潰す
- **意図が読める名前に**: “なぜそうするか”が伝わる命名（抽象度を上げすぎない）

## “次の一手”の選び方（迷ったときの判断基準）
- **テストが書きにくい → 設計の匂い**: 依存が濃い/責務が大きい/境界が曖昧。まず分離する方向を検討
- **条件分岐が増えた → 例を増やす**: 仕様の例（テストケース）を追加してから一般化する
- **バグ修正 → 先に再現テスト**: 失敗する再現テストを追加 → 修正 → 回帰防止が完成

## テストの書き方（t_wada式の実務コツ）
- **AAA（Arrange-Act-Assert）** で読みやすく: 準備/実行/検証が分かれるように整理
- **1テスト1アサーション…に縛られすぎない**: “1つの関心事”に対する検証がまとまっていればOK
- **テスト名は仕様文**: 「〜のとき、〜する」形式（入力条件と期待を含める）
- **データ生成を抽象化しすぎない**: FactoryやBuilderは必要最小限。読める具体性を優先
- **失敗メッセージが価値**: 期待値は読みやすい形で（例: オブジェクトの差分が出る、文字列が明確）

## アンチパターン（やりがちな落とし穴）
- **テストが実装に密結合**: private構造やDOMの細部、内部呼び出し回数に依存しすぎない（ふるまいで検証）
- **一度に大きく変える**: Red/Green/Refactorのサイクルが崩れるほどの大改修は分割する
- **サイクルを回さない**: 全ての機能を一回のサイクルで実行しない。機能ごとにサイクルを実行する。
- **テストが遅すぎる**: 速い単体テスト中心。遅い統合/E2Eは“薄く”・要所だけ
- **グリーンで止める**: 通ったら必ず小さく整える（重複と命名の負債は放置しない）

## このリポジトリでの運用メモ
- **テストの配置**: `ts/tsx` のテスト運用は `testing` skill に従う（対象ファイルと同じディレクトリに `*.test.ts(x)`）
- **UI/拡張API周り**: WXT/ブラウザ拡張APIに触れる箇所は境界を薄くし、中心ロジックを単体テストできる形に寄せる

## 最小チェックリスト
- **Red**: 追加したテストがまず失敗する
- **Green**: 最短で通した（過剰一般化していない）
- **Refactor**: 重複/命名/責務が改善され、テストは通ったまま
- **バグ修正**: 再現テストがあり、回帰を防げる
